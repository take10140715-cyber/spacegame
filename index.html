<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POP STAR V28 (Touch Optimized)</title>
    <!-- p5.js „É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #2b1d3d;
            overflow: hidden;
            font-family: 'Verdana', sans-serif;
            color: white;
            
            /* --- „Çø„ÉÉ„ÉÅÊìç‰ΩúÂØæÁ≠ñ: ÈÅ∏Êäû„ÉªÈï∑Êäº„Åó„É°„Éã„É•„Éº„ÇíÁÑ°ÂäπÂåñ --- */
            user-select: none;
            -webkit-user-select: none; /* Safari/Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            
            touch-action: none;        /* „Éñ„É©„Ç¶„Ç∂„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Éª„Ç∫„Éº„É†ÁÑ°Âäπ */
            -webkit-touch-callout: none; /* iOSÈï∑Êäº„Åó„É°„Éã„É•„ÉºÁÑ°Âäπ */
            -webkit-tap-highlight-color: transparent; /* „Çø„ÉÉ„ÉóÊôÇ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÁÑ°Âäπ */
        }

        /* „Ç≠„É£„É≥„Éê„Çπ„ÇíËÉåÊôØ„Å´Âõ∫ÂÆö */
        canvas {
            display: block;
            position: fixed;
            top: 0; left: 0;
            z-index: 0;
            touch-action: none;
        }

        /* UI„É¨„Ç§„É§„Éº */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ÁîªÈù¢ */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(30, 20, 50, 0.95);
            pointer-events: auto;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
            z-index: 20;
        }
        .hidden { opacity: 0; pointer-events: none !important; visibility: hidden; }

        h1 {
            font-size: 48px; margin: 0 0 20px 0; color: #ff99cc;
            text-shadow: 4px 4px 0 #fff; text-align: center;
            pointer-events: none; /* ÊñáÂ≠óÈÅ∏ÊäûÈò≤Ê≠¢ */
        }

        p { font-size: 16px; color: #eee; text-align: center; line-height: 1.8; margin-bottom: 30px; pointer-events: none; }

        button {
            background: #ff6699; border: 4px solid #fff;
            padding: 15px 60px; font-size: 24px; color: #fff;
            border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 6px 0 #cc4477;
            transition: transform 0.1s; pointer-events: auto;
            touch-action: manipulation;
            user-select: none; -webkit-user-select: none;
        }
        button:active { transform: translateY(6px); box-shadow: 0 0 0 #cc4477; }

        #hud { position: absolute; top: 20px; left: 20px; text-align: left; pointer-events: none; }
        .hud-text { font-size: 22px; font-weight: bold; margin-bottom: 5px; text-shadow: 2px 2px 0 #ff6699; }
        
        #xp-bar-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 14px; background: rgba(0,0,0,0.5);
            border: 3px solid #fff; border-radius: 10px; overflow: hidden; pointer-events: none;
        }
        #xp-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ffcc00, #ff6699); transition: width 0.2s; }
        #level-badge {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            font-size: 18px; font-weight: bold; color: #fff; text-shadow: 2px 2px 0 #000; pointer-events: none;
        }

        .card-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-width: 800px; pointer-events: none; }
        .upgrade-card {
            background: #fff; border: 4px solid #ffcc00; border-radius: 16px;
            padding: 15px; width: 140px; color: #333;
            cursor: pointer; pointer-events: auto; text-align: center;
            box-shadow: 0 6px 0 #cc9900; transition: transform 0.1s;
            user-select: none; -webkit-user-select: none;
        }
        .upgrade-card:active { transform: translateY(6px); box-shadow: 0 0 0 #cc9900; }
        .card-icon { font-size: 40px; margin-bottom: 5px; pointer-events: none; }
        .card-title { font-size: 14px; font-weight: bold; color: #ff6699; margin-bottom: 5px; pointer-events: none; }
        .card-desc { font-size: 11px; color: #555; line-height: 1.2; pointer-events: none; }

        #boss-warning {
            position: absolute; top: 40%; left: 0; width: 100%;
            text-align: center; font-size: 60px; font-weight: 900; color: #ff3366;
            text-shadow: 4px 4px 0 #fff; display: none; z-index: 5;
            animation: bounce 0.5s infinite alternate; pointer-events: none;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }

        #joystick-zone {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.6); font-size: 16px; pointer-events: none; display: none;
            text-shadow: 1px 1px 2px #000; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="hud">
            <div id="score-display" class="hud-text">SCORE: 0</div>
            <div id="lives-display" class="hud-text">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
        <div id="level-badge">Lv.1</div>
        <div id="boss-warning">BOSS!</div>
        <div id="joystick-zone">‚óÑ ÁîªÈù¢„Çí„Å™„Åû„Å£„Å¶ÁßªÂãï ‚ñ∫</div>

        <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
        <div id="startScreen" class="overlay-screen">
            <h1>POP STAR<br>SURVIVOR</h1>
            <p>
                [„Çø„ÉÉ„ÉÅÊúÄÈÅ©ÂåñÁâà]<br>
                Èï∑Êäº„Åó„Å´„Çà„ÇãÈÅ∏Êäû„ÇíÈò≤„Åé„Åæ„Åó„Åü„ÄÇ<br>
                ÁîªÈù¢„Çí„Å™„Åû„Å£„Å¶Ëá™Ê©ü„ÇíÊìç‰ΩúÔºÅ<br>
                „Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅßÈñãÂßãÔºÅ
            </p>
            <button id="startBtn">START!</button>
        </div>

        <!-- „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÁîªÈù¢ -->
        <div id="levelUpScreen" class="overlay-screen hidden">
            <h2 style="color: #ffcc00; text-shadow: 3px 3px 0 #fff; font-size: 40px; margin-bottom: 20px;">LEVEL UP!</h2>
            <div id="cardsContainer" class="card-container"></div>
        </div>

        <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
        <div id="gameOverScreen" class="overlay-screen hidden">
            <h1 style="color: #ff3366;">GAME OVER</h1>
            <p id="finalScore" style="font-size: 24px; font-weight: bold; color: #fff;">SCORE: 0</p>
            <button id="restartBtn">RETRY</button>
        </div>
    </div>

    <script>
        // === 1. „Ç≥„É≥„Éï„Ç£„Ç∞ ===
        const CONFIG = {
            MAX_LIVES: 3,
            PLAYER_SPEED: 7, 
            TOUCH_SENSITIVITY: 1.3,
            INVINCIBLE_TIME: 120,
            PICKUP_RADIUS: 120,
            BOSS_INTERVAL: 1800, 
            MAX_ENEMIES: 80,
            XP_GROWTH: 1.2
        };

        // === 2. „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ===
        let player = null;
        let enemies = [];
        let bullets = [];
        let enemyBullets = [];
        let particles = [];
        let gems = [];
        let texts = [];
        
        let score = 0;
        let gameState = "MENU";
        let frameCnt = 0;
        let bossKillCount = 0;
        let nextBossTimer = 0;
        let isBossActive = false;
        let screenShake = 0;

        // „Çø„ÉÉ„ÉÅÊìç‰ΩúÁî®
        let prevTouchX = 0;
        let prevTouchY = 0;
        let isTouching = false;

        // === 3. „ÇØ„É©„ÇπÂÆöÁæ© ===

        class Player {
            constructor() {
                let w = typeof width !== 'undefined' ? width : window.innerWidth;
                let h = typeof height !== 'undefined' ? height : window.innerHeight;
                this.pos = createVector(w/2, h/2);
                this.lives = CONFIG.MAX_LIVES;
                this.invincible = 0;
                this.level = 1;
                this.xp = 0;
                this.nextXp = 20;
                this.faceDir = 1; 
                this.animAngle = 0;

                this.stats = {
                    speed: CONFIG.PLAYER_SPEED,
                    pickup: CONFIG.PICKUP_RADIUS,
                    dmg: 10, rate: 15, count: 1,
                    missile: 0, shield: 0, 
                    shieldActive: false, shieldCool: 0
                };
                this.timers = { shot: 0, missile: 0 };
            }

            update() {
                // „Ç≠„Éº„Éú„Éº„Éâ
                let dx = 0, dy = 0;
                if (keyIsDown(87) || keyIsDown(UP_ARROW)) dy = -1;
                if (keyIsDown(83) || keyIsDown(DOWN_ARROW)) dy = 1;
                if (keyIsDown(65) || keyIsDown(LEFT_ARROW)) dx = -1;
                if (keyIsDown(68) || keyIsDown(RIGHT_ARROW)) dx = 1;
                
                // „Çø„ÉÉ„ÉÅÔºà„ÉÄ„Ç§„É¨„ÇØ„ÉàÁõ∏ÂØæÁßªÂãïÔºâ
                if (touches.length > 0) {
                    let t = touches[0];
                    if (!isTouching) {
                        prevTouchX = t.x;
                        prevTouchY = t.y;
                        isTouching = true;
                    } else {
                        let touchDx = t.x - prevTouchX;
                        let touchDy = t.y - prevTouchY;
                        
                        this.pos.x += touchDx * CONFIG.TOUCH_SENSITIVITY;
                        this.pos.y += touchDy * CONFIG.TOUCH_SENSITIVITY;

                        if(touchDx > 1) this.faceDir = 1;
                        if(touchDx < -1) this.faceDir = -1;

                        prevTouchX = t.x;
                        prevTouchY = t.y;
                    }
                } else {
                    isTouching = false;
                }

                if (dx !== 0 || dy !== 0) {
                    let move = createVector(dx, dy).normalize().mult(this.stats.speed);
                    this.pos.add(move);
                    if(dx > 0) this.faceDir = 1;
                    if(dx < 0) this.faceDir = -1;
                }

                // ÁîªÈù¢Á´ØÂà∂Èôê
                if(typeof width !== 'undefined') {
                    this.pos.x = constrain(this.pos.x, 25, width-25);
                    this.pos.y = constrain(this.pos.y, 25, height-25);
                }

                if (this.invincible > 0) this.invincible--;
                this.animAngle += 0.05;

                if(this.stats.shield > 0 && !this.stats.shieldActive) {
                    if(this.stats.shieldCool > 0) this.stats.shieldCool--;
                    else this.stats.shieldActive = true;
                }

                this.attack();
            }

            attack() {
                if (frameCnt % this.stats.rate === 0) {
                    let target = this.getNearestEnemy();
                    let a = target ? p5.Vector.sub(target.pos, this.pos).heading() : (this.faceDir===1?0:PI);
                    let spread = 0.2;
                    let start = a - (spread * (this.stats.count - 1)) / 2;
                    
                    for(let i=0; i<this.stats.count; i++) {
                        bullets.push(new Bullet(this.pos.x, this.pos.y, start + spread*i, this.stats.dmg, 'STAR'));
                    }
                }
                if (this.stats.missile > 0 && frameCnt % 60 === 0) {
                    for(let i=0; i<this.stats.missile; i++) {
                        bullets.push(new Bullet(this.pos.x, this.pos.y, random(TWO_PI), this.stats.dmg*1.5, 'CANDY'));
                    }
                }
            }

            display() {
                if (this.invincible > 0 && floor(frameCnt/4)%2===0) return;

                push();
                translate(this.pos.x, this.pos.y);
                translate(0, sin(this.animAngle * 2) * 5);

                if (this.stats.shieldActive) {
                    noFill(); stroke(180, 50, 100, 50); strokeWeight(3);
                    ellipse(0, 0, 70, 70);
                }

                scale(this.faceDir, 1);
                noStroke();
                
                // Star
                push(); rotate(this.animAngle); drawStar(0, 0, 18, 35, 5, color(50, 80, 100)); pop();

                // Character
                fill(320, 60, 90); ellipse(0, -10, 20, 25);
                fill(280, 60, 80); triangle(-8, -15, -20, 5, -5, 5);
                fill(30, 20, 100); ellipse(0, -22, 22, 22);
                fill(280, 80, 60); triangle(-16, -26, 16, -26, 0, -55 + sin(this.animAngle*4)*2);
                ellipse(0, -26, 36, 10);
                fill(0); ellipse(4, -22, 3, 3); ellipse(-4, -22, 3, 3);
                fill(350, 60, 90); ellipse(6, -18, 4, 2); ellipse(-6, -18, 4, 2);
                stroke(40, 60, 60); strokeWeight(2); line(12, -10, 22, -20);
                noStroke(); fill(0, 80, 100); ellipse(22, -20, 7, 7);

                pop();
            }

            getNearestEnemy() {
                let nearest = null;
                let minDist = Infinity;
                for (let e of enemies) {
                    let d = p5.Vector.dist(this.pos, e.pos);
                    if (d < minDist) { minDist = d; nearest = e; }
                }
                return nearest;
            }

            hit() {
                if (this.invincible > 0) return;
                
                if(this.stats.shieldActive) {
                    this.stats.shieldActive = false;
                    this.stats.shieldCool = 300;
                    this.invincible = 30;
                    texts.push(new FloatingText(this.pos.x, this.pos.y-30, "BLOCK!", color(180, 50, 100)));
                    return;
                }

                this.lives--;
                this.invincible = CONFIG.INVINCIBLE_TIME;
                screenShake = 15;
                
                for(let e of enemies) {
                    if(p5.Vector.dist(this.pos, e.pos) < 200) e.takeDamage(100);
                }
                updateHud();
                if (this.lives <= 0) gameOver();
            }

            gainXp(amt) {
                this.xp += amt;
                if (this.xp >= this.nextXp) {
                    this.level++;
                    this.xp = 0;
                    this.nextXp = floor(this.nextXp * 1.2);
                    levelUp();
                }
                updateHud();
            }
        }

        class Enemy {
            constructor(isBoss) {
                this.isBoss = isBoss;
                this.dead = false;
                
                let ang = random(TWO_PI);
                let d = (typeof width !== 'undefined' ? (width > height ? width : height) : 1000) / 1.5 + 100;
                this.pos = createVector(player.pos.x + cos(ang)*d, player.pos.y + sin(ang)*d);
                this.vel = createVector(0,0);
                this.anim = random(100);
                
                let rank = 1 + (frameCnt / 3600);

                if (isBoss) {
                    this.hp = 2000 * rank; this.maxHp = this.hp;
                    this.size = 80; this.speed = 1.0; 
                    this.col = color(340, 80, 90); 
                    this.xp = 2000;
                } else {
                    let r = random();
                    if(r < 0.3) { 
                        this.type = 'BAT'; this.hp = 15 * rank; this.size = 20; this.speed = 3.0; 
                        this.col = color(270, 70, 80); this.xp = 15;
                    } else if(r < 0.5) { 
                        this.type = 'GOLEM'; this.hp = 60 * rank; this.size = 35; this.speed = 0.8; 
                        this.col = color(140, 60, 60); this.xp = 30;
                    } else { 
                        this.type = 'SLIME'; this.hp = 25 * rank; this.size = 25; this.speed = 1.5; 
                        this.col = color(200, 70, 90); this.xp = 10;
                    }
                    this.maxHp = this.hp;
                }
            }

            update() {
                let dir = p5.Vector.sub(player.pos, this.pos);
                dir.normalize();
                dir.mult(this.speed);
                this.pos.add(dir);
                this.anim += 0.2;

                if (p5.Vector.dist(this.pos, player.pos) < (this.size/2 + 15)) {
                    player.hit();
                }

                if (this.isBoss && frameCnt % 100 === 0) {
                    let count = 8;
                    for (let i = 0; i < count; i++) {
                        let a = (TWO_PI / count) * i + this.anim*0.1;
                        enemyBullets.push(new EnemyBullet(this.pos.x, this.pos.y, a));
                    }
                }
            }

            display() {
                push();
                translate(this.pos.x, this.pos.y);
                noStroke();
                let bounce = sin(this.anim) * 3;

                if (this.isBoss) {
                    fill(this.col);
                    beginShape(); vertex(-40, -40 + bounce); bezierVertex(-60, 20, -20, 50, 0, 50); bezierVertex(20, 50, 60, 20, 40, -40 + bounce); endShape(CLOSE);
                    fill(60, 80, 100); beginShape(); vertex(-25, -40+bounce); vertex(-15, -60+bounce); vertex(0, -45+bounce); vertex(15, -60+bounce); vertex(25, -40+bounce); endShape(CLOSE);
                    fill(255); ellipse(-15, 0, 15, 15); ellipse(15, 0, 15, 15);
                    fill(0); ellipse(-15, 0, 5, 5); ellipse(15, 0, 5, 5);
                    noFill(); stroke(0); strokeWeight(3); arc(0, 10, 20, 10, 0, PI);
                    noStroke(); fill(0, 0, 30); rect(-40, -80, 80, 8, 4); fill(0, 80, 90); rect(-40, -80, 80 * (this.hp/this.maxHp), 8, 4);
                } else if(this.type === 'BAT') {
                    fill(this.col);
                    let w = sin(this.anim*2)*10;
                    triangle(-5, 0, -20, -10+w, -5, 10); triangle(5, 0, 20, -10+w, 5, 10);
                    ellipse(0, 0, 15, 15); fill(60, 80, 100); ellipse(-3, -2, 4, 4); ellipse(3, -2, 4, 4);
                } else if(this.type === 'GOLEM') {
                    fill(this.col);
                    rectMode(CENTER); rect(0, bounce, 30, 30, 5);
                    fill(0, 0, 100); rect(0, bounce-5, 20, 8); fill(0); ellipse(-5, bounce-5, 3, 3); ellipse(5, bounce-5, 3, 3);
                } else {
                    fill(this.col);
                    beginShape(); vertex(-12, -10 + bounce); bezierVertex(-20, 10, -10, 15, 0, 15); bezierVertex(10, 15, 20, 10, 12, -10 + bounce); endShape(CLOSE);
                    fill(255); ellipse(-5, -2+bounce, 6, 6); ellipse(5, -2+bounce, 6, 6); fill(0); ellipse(-5, -2+bounce, 2, 2); ellipse(5, -2+bounce, 2, 2);
                }
                pop();
            }

            takeDamage(dmg) {
                this.hp -= dmg;
                texts.push(new FloatingText(this.pos.x, this.pos.y-20, floor(dmg), color(0,0,100)));
                if (this.hp <= 0 && !this.dead) {
                    this.dead = true;
                    score += this.isBoss ? 1000 : 10;
                    if(this.isBoss) {
                        for(let i=0; i<15; i++) gems.push(new Gem(this.pos.x+random(-40,40), this.pos.y+random(-40,40), this.xp/15));
                        isBossActive=false; bossKillCount++;
                        nextBossTimer=max(600, CONFIG.BOSS_INTERVAL - bossKillCount*200);
                        for(let b of enemyBullets) b.dead=true;
                    } else {
                        gems.push(new Gem(this.pos.x, this.pos.y, this.xp));
                    }
                    let pCount = this.isBoss ? 30 : 5;
                    for(let i=0; i<pCount; i++) particles.push(new Particle(this.pos.x, this.pos.y, this.col));
                    updateHud();
                }
            }
        }

        class Bullet {
            constructor(x, y, angle, dmg, type) {
                this.pos = createVector(x, y);
                this.vel = p5.Vector.fromAngle(angle).mult(10);
                this.dmg = dmg; this.type = type;
                this.life = 60; this.dead = false; this.rot = 0;
            }
            update() {
                this.pos.add(this.vel);
                this.life--; this.rot += 0.2;
                if(this.life<=0 || this.pos.x<0 || this.pos.x>width || this.pos.y<0 || this.pos.y>height) this.dead=true;
                
                for(let e of enemies) {
                    if(!e.dead && p5.Vector.dist(this.pos, e.pos) < e.size/2 + 10) {
                        e.takeDamage(this.dmg); this.dead=true; break;
                    }
                }
            }
            display() {
                push(); translate(this.pos.x, this.pos.y); rotate(this.rot); noStroke();
                if(this.type === 'CANDY') {
                    fill(330, 70, 100); ellipse(0,0, 12, 12);
                    triangle(-6,0, -10,-4, -10,4); triangle(6,0, 10,-4, 10,4);
                } else {
                    drawStar(0, 0, 6, 14, 5, color(50, 90, 100));
                }
                pop();
            }
        }

        class EnemyBullet {
            constructor(x, y, angle) {
                this.pos = createVector(x, y);
                this.vel = p5.Vector.fromAngle(angle).mult(4);
                this.life=180; this.dead=false;
            }
            update() {
                this.pos.add(this.vel);
                this.life--; if(this.life<=0) this.dead=true;
                if(p5.Vector.dist(this.pos, player.pos)<15) { player.hit(); this.dead=true; }
            }
            display() {
                fill(0, 80, 90); noStroke(); ellipse(this.pos.x, this.pos.y, 14, 14);
            }
        }

        class Gem {
            constructor(x, y, val) {
                this.pos = createVector(x, y);
                this.val = val; this.dead = false; this.rot = random(TWO_PI);
            }
            update() {
                let d = p5.Vector.dist(this.pos, player.pos);
                if(d < player.stats.pickup) {
                    let dir = p5.Vector.sub(player.pos, this.pos);
                    dir.setMag(12); this.pos.add(dir);
                }
                if(d < 20) { player.gainXp(this.val); this.dead = true; }
                this.rot += 0.05;
            }
            display() {
                push(); translate(this.pos.x, this.pos.y); rotate(this.rot);
                fill(190, 60, 100); noStroke(); rectMode(CENTER); rect(0,0, 10, 10, 2);
                pop();
            }
        }

        class Particle {
            constructor(x, y, col) {
                this.pos = createVector(x, y);
                this.vel = p5.Vector.random2D().mult(random(2, 5));
                this.col = col; this.life = 255; this.dead = false;
            }
            update() {
                this.pos.add(this.vel); this.life -= 15; if(this.life<=0) this.dead=true;
            }
            display() {
                noStroke(); let c = color(this.col); c.setAlpha(this.life/255*100);
                fill(c); ellipse(this.pos.x, this.pos.y, 6, 6);
            }
        }

        class FloatingText {
            constructor(x, y, txt, col) {
                this.pos = createVector(x, y); this.txt = txt; this.col = col; this.life = 40; this.dead = false;
            }
            update() { this.pos.y -= 1; this.life--; if(this.life<=0) this.dead=true; }
            display() {
                fill(this.col); noStroke(); textAlign(CENTER); textStyle(BOLD); textSize(16);
                text(this.txt, this.pos.x, this.pos.y);
            }
        }

        function drawStar(x, y, r1, r2, n, col) {
            fill(col); noStroke();
            let angle = TWO_PI / n; let halfAngle = angle/2.0;
            beginShape();
            for (let a = 0; a < TWO_PI; a += angle) {
                let sx = x + cos(a) * r2; let sy = y + sin(a) * r2; vertex(sx, sy);
                sx = x + cos(a + halfAngle) * r1; sy = y + sin(a + halfAngle) * r1; vertex(sx, sy);
            }
            endShape(CLOSE);
        }

        // === 4. „Ç∑„Çπ„ÉÜ„É†Èñ¢Êï∞ ===

        function setup() {
            let cnv = createCanvas(windowWidth, windowHeight);
            cnv.id('gameCanvas');
            frameRate(60);
            colorMode(HSB, 360, 100, 100, 100);
            smooth();

            // „É¢„Éê„Ç§„É´ÂØæÁ≠ñ
            if ('ontouchstart' in window) {
                document.getElementById('joystick-zone').style.display = 'block';
            }
            
            // ÈáçË¶ÅÔºöÂè≥„ÇØ„É™„ÉÉ„ÇØ„ÉªÈï∑Êäº„Åó„É°„Éã„É•„ÉºÁ¶ÅÊ≠¢
            document.addEventListener('contextmenu', event => event.preventDefault());
            
            resetGameParams();
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function resetGameParams() {
            // PlayerÂàùÊúüÂåñÔºàÁîªÈù¢„Çµ„Ç§„Ç∫„ÅåÁ¢∫ÂÆö„Åó„Å¶„Åã„ÇâÔºâ
            let w = typeof width !== 'undefined' ? width : window.innerWidth;
            let h = typeof height !== 'undefined' ? height : window.innerHeight;
            
            if(!player) player = new Player();
            player.pos = createVector(w/2, h/2);
            player.lives = CONFIG.MAX_LIVES;
            player.xp = 0;
            player.level = 1;
            player.nextXp = 20;
            player.stats.count = 1;
            player.stats.dmg = 10;
            player.stats.rate = 15;
            player.stats.missile = 0;
            player.stats.shield = 0;
            player.stats.shieldActive = false;
            
            enemies = []; bullets = []; enemyBullets = []; particles = []; gems = []; texts = [];
            score = 0; frameCnt = 0; bossKillCount = 0;
            nextBossTimer = CONFIG.BOSS_INTERVAL;
            isBossActive = false;
            updateHud();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');

            // „Çø„ÉÉ„ÉÅ„Å®„ÇØ„É™„ÉÉ„ÇØ„ÅÆ‰∏°Êñπ„ÅßÂèçÂøú„Åô„Çã„Çà„ÅÜ„Å´„Åô„Çã
            const startGameHandler = (e) => {
                // „Éú„Çø„É≥‰ª•Â§ñ„Å∏„ÅÆ‰ºùÊí≠„ÇíÊ≠¢„ÇÅ„Çã
                e.preventDefault(); 
                e.stopPropagation();
                document.getElementById('startScreen').classList.add('hidden');
                resetGameParams();
                gameState = "PLAYING";
            };

            const resetGameHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('gameOverScreen').classList.add('hidden');
                resetGameParams();
                gameState = "PLAYING";
            };

            startBtn.addEventListener('click', startGameHandler);
            startBtn.addEventListener('touchend', startGameHandler);

            restartBtn.addEventListener('click', resetGameHandler);
            restartBtn.addEventListener('touchend', resetGameHandler);
            
            // ÁîªÈù¢ÂÖ®‰Ωì„ÅÆÈï∑Êäº„ÅóÈò≤Ê≠¢Ôºà„Éú„Çø„É≥‰ª•Â§ñÔºâ
            window.addEventListener('touchstart', function(e) {
                if(e.target.tagName !== 'BUTTON' && e.target.closest('.upgrade-card') === null) {
                    e.preventDefault();
                }
            }, {passive: false});
        });

        // === 5. „É°„Ç§„É≥„É´„Éº„Éó ===
        function draw() {
            background(270, 60, 20); 

            if (gameState === "PLAYING") {
                push();
                
                // ÁîªÈù¢Êè∫„Çå
                if (screenShake > 0) {
                    translate(random(-screenShake, screenShake), random(-screenShake, screenShake));
                    screenShake *= 0.9;
                    if(screenShake < 0.5) screenShake = 0;
                }

                // ÊòüÁ©∫
                noStroke();
                for(let i=0; i<40; i++) {
                    let x = (i * 113 + frameCnt * 0.2) % width;
                    let y = (i * 239 + frameCnt * 0.1) % height;
                    let size = (sin(frameCnt * 0.05 + i) + 2) * 1.5;
                    fill(60, 30, 100, 40);
                    ellipse(x, y, size, size);
                }

                // ÂÆâÂÖ®Ë£ÖÁΩÆÔºöplayer„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞
                if(player) {
                    updateGameLogic();
                }

                pop();
                frameCnt++;
            }
        }

        function updateGameLogic() {
            player.update();
            player.display();

            if (enemies.length < CONFIG.MAX_ENEMIES) {
                let rate = max(10, 60 - floor(frameCnt / 300) - (bossKillCount * 5));
                if (frameCnt % rate === 0) enemies.push(new Enemy(false));
            }

            if (!isBossActive) {
                nextBossTimer--;
                if (nextBossTimer <= 0) spawnBoss();
            } else {
                if (!enemies.some(e => e.isBoss)) {
                    isBossActive = false; nextBossTimer = 100;
                }
            }

            updateList(bullets);
            updateList(enemyBullets);
            updateList(enemies);
            updateList(gems);
            updateList(particles);
            updateList(texts);
        }

        function updateList(list) {
            for (let i = list.length - 1; i >= 0; i--) {
                list[i].update();
                list[i].display();
                if (list[i].dead) list.splice(i, 1);
            }
        }

        function spawnBoss() {
            isBossActive = true;
            nextBossTimer = CONFIG.BOSS_INTERVAL;
            enemies.push(new Enemy(true));
            for(let e of enemies) if(!e.isBoss) e.takeDamage(999);
            const w = document.getElementById('boss-warning');
            w.style.display = 'block'; setTimeout(() => w.style.display = 'none', 3000);
        }

        function updateHud() {
            if(!player) return;
            document.getElementById('score-display').innerText = `SCORE: ${score}`;
            document.getElementById('lives-display').innerText = '‚ù§Ô∏è'.repeat(max(0, player.lives));
            document.getElementById('level-badge').innerText = `Lv.${player.level}`;
            let pct = min(100, (player.xp / player.nextXp) * 100);
            document.getElementById('xp-bar-fill').style.width = `${pct}%`;
        }

        function gameOver() {
            gameState = "GAME_OVER";
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = `SCORE: ${score}`;
        }

        const UPGRADES = [
            { id: 'dmg', title: 'POWER UP', desc:'Êòü„ÅÆ„ÅÑ„Çä„Çá„Åè„Ç¢„ÉÉ„Éó', icon: 'üåü', apply: () => player.stats.dmg += 5 },
            { id: 'count', title: 'MULTI STAR', desc:'Êòü„ÅÆ„Åã„Åö+1', icon: '‚ú®', apply: () => player.stats.count++ },
            { id: 'missile', title: 'CANDY', desc:'„Å§„ÅÑ„Å≥„Ç≠„É£„É≥„Éá„Ç£', icon: 'üç¨', apply: () => player.stats.missile++ },
            { id: 'shield', title: 'BARRIER', desc:'„Éê„É™„Ç¢(1Âõû)', icon: 'üõ°Ô∏è', apply: () => { player.stats.shield++; player.stats.shieldCool = 0; } },
            { id: 'speed', title: 'SPEED', desc:'„ÅÑ„Å©„ÅÜ„Åù„Åè„Å©„Ç¢„ÉÉ„Éó', icon: 'üëü', apply: () => player.stats.speed += 1 },
            { id: 'heal', title: 'HEAL', desc:'„Éè„Éº„Éà„Åã„ÅÑ„Åµ„Åè', icon: 'üíñ', rare:true, apply: () => { if(player.lives<CONFIG.MAX_LIVES) player.lives++; } }
        ];

        function levelUp() {
            gameState = "LEVEL_UP";
            const c = document.getElementById('cardsContainer'); c.innerHTML = '';
            document.getElementById('levelUpScreen').classList.remove('hidden');
            const choices = [];
            while(choices.length < 3) {
                const u = random(UPGRADES);
                if(u.id==='heal' && player.lives>=CONFIG.MAX_LIVES) continue;
                if(!choices.includes(u)) choices.push(u);
            }
            choices.forEach(u => {
                const div = document.createElement('div');
                div.className = `upgrade-card ${u.rare?'card-rare':''}`;
                div.innerHTML = `<div class="card-icon">${u.icon}</div><div class="card-title">${u.title}</div><div class="card-desc">${u.desc}</div>`;
                
                // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„Éª„Çø„ÉÉ„ÉÅÂá¶ÁêÜ
                const selectUpgrade = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    u.apply();
                    document.getElementById('levelUpScreen').classList.add('hidden');
                    gameState = "PLAYING";
                    player.invincible = 60;
                };
                div.addEventListener('click', selectUpgrade);
                div.addEventListener('touchend', selectUpgrade);
                
                c.appendChild(div);
            });
        }
    </script>
</body>
</html>
